<!DOCTYPE html>
<html lang="en">

<head>
	<meta charset="UTF-8">
	<meta name="viewport" content="width=device-width, initial-scale=1.0">
	<title>Multi-Task Time Tracker</title>
	<!-- Load Tailwind CSS -->
	<script src="https://cdn.tailwindcss.com"></script>
	<!-- Load Chart.js for Visualization (P2 Completion) -->
	<script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.3/dist/chart.umd.min.js"></script>
	<!-- Load Google API Client Library -->
	<script src="https://apis.google.com/js/api.js"></script>
	<script src="https://accounts.google.com/gsi/client" async defer></script>
	<!-- Configure Font -->
	<style>
		@import url('https://fonts.googleapis.com/css2?family=Inter:wght@400;600;700&display=swap');

		body {
			font-family: 'Inter', sans-serif;
		}

		.collapse-icon {
			transition: transform 0.2s;
		}

		.rotate-90 {
			transform: rotate(90deg);
		}

		.paused-card {
			border-left: 4px solid #f97316;
		}

		/* Orange-500 */
		.tab-button.active {
			border-bottom: 3px solid #4f46e5;
			/* Indigo-600 */
			color: #1f2937;
			/* Gray-800 */
			font-weight: 600;
		}
	</style>
</head>

<body class="bg-gray-50 min-h-screen p-4 sm:p-8">

	<div id="app" class="max-w-4xl mx-auto bg-white shadow-2xl rounded-xl p-6 sm:p-10">
		<h1 class="text-3xl font-bold text-gray-800 mb-6 text-center">Multi-Task Tracker</h1>

		<!-- Sign In Section (shown when not authenticated) -->
		<div id="signin-section" class="text-center py-12 hidden">
			<p class="text-gray-600 mb-6">Please sign in with Google to access your time tracking data.</p>
			<button id="authorize-button"
				class="bg-indigo-600 text-white font-semibold px-6 py-3 rounded-lg shadow-md hover:bg-indigo-700 transition duration-300">
				Sign In with Google
			</button>
			<p id="signin-error" class="text-red-500 mt-4 text-sm"></p>
		</div>

		<!-- Tab Navigation (hidden until authenticated) -->
		<div id="main-content" class="hidden">
			<div class="flex border-b border-gray-200 mb-6">
				<button id="tab-tracker" data-tab="tracker"
					class="tab-button active flex-1 py-3 text-center text-gray-500 hover:text-gray-800 transition duration-150">
					Time Tracker
				</button>
				<button id="tab-reports" data-tab="reports"
					class="tab-button flex-1 py-3 text-center text-gray-500 hover:text-gray-800 transition duration-150">
					Reports & Analytics
				</button>
			</div>

			<!-- Content Views -->
			<div id="view-tracker" class="content-view">
				<p class="text-sm text-gray-500 mb-6 text-center">Format: <span
						class="font-mono bg-gray-100 p-1 rounded-md">Project / Task</span></p>

				<!-- Smart Activity Input with Datalist -->
				<div class="flex flex-col sm:flex-row gap-3 mb-4">
					<input list="activity-suggestions" type="text" id="topic-input"
						placeholder="Enter Project / Task or select from suggestions"
						class="flex-grow px-4 py-3 border border-gray-300 rounded-lg text-lg focus:outline-none focus:ring-2 focus:ring-indigo-500 transition duration-150">
					<datalist id="activity-suggestions"></datalist>

					<button id="start-button"
						class="w-full sm:w-32 flex-shrink-0 text-white font-semibold py-3 rounded-lg shadow-md bg-indigo-600 hover:bg-indigo-700 transition duration-300 focus:outline-none focus:ring-4 focus:ring-indigo-300 disabled:bg-gray-400">
						Start
					</button>
				</div>

				<p id="error-message" class="text-sm text-red-500 mb-4 h-5"></p>

				<!-- Active Timers Display -->
				<h2 class="text-xl font-semibold text-gray-700 mb-4 border-b pb-2">Active Timers (<span
						id="active-count">0</span>)</h2>

				<div id="active-timers-list" class="space-y-4 mb-8 min-h-[100px] p-2">
					<p id="no-active-message" class="text-gray-500 text-center py-4">No tasks currently running.</p>
				</div>

				<!-- Data Management Section -->
				<div class="mt-8 pt-4 border-t border-gray-200">
					<h2 class="text-xl font-semibold text-gray-700 mb-4">Data Management</h2>
					<button id="export-button"
						class="w-full bg-gray-600 text-white font-semibold py-3 rounded-lg shadow-md transition duration-300 hover:bg-gray-700 focus:outline-none focus:ring-4 focus:ring-gray-300">
						Open Google Sheet
					</button>
				</div>
			</div>

			<div id="view-reports" class="content-view hidden">
				<div id="reports-loading" class="text-center text-gray-500 py-12">Loading historical data...</div>
				<div id="reports-error" class="text-center text-red-500 py-12 hidden">Error loading reports. Check console.
				</div>

				<div id="reports-content" class="space-y-12 hidden">
					<h3 class="text-2xl font-semibold text-gray-700 border-b pb-2">Time Distribution by Project</h3>
					<div class="flex justify-center h-80">
						<canvas id="project-pie-chart"></canvas>
					</div>

					<h3 class="text-2xl font-semibold text-gray-700 border-b pb-2 pt-6">Daily Time Logged (Last 7 Days)</h3>
					<div class="h-80">
						<canvas id="daily-bar-chart"></canvas>
					</div>
				</div>
			</div>

			<!-- Status and ID Display -->
			<p class="text-sm text-center text-gray-400 mt-6" id="user-id-display">Status: Loading...</p>
		</div>
	</div>

	<!-- Google Sheets API Setup -->
	<script>
		// === CONFIGURATION: Replace these with your credentials ===
		const API_KEY = 'YOUR_API_KEY_HERE';  // From Google Cloud Console
		const CLIENT_ID = 'YOUR_CLIENT_ID_HERE';  // From Google Cloud Console
		const SPREADSHEET_ID = 'YOUR_SPREADSHEET_ID_HERE';  // From your Google Sheet URL
		// ==========================================================

		const DISCOVERY_DOC = 'https://sheets.googleapis.com/$discovery/rest?version=v4';
		const SCOPES = 'https://www.googleapis.com/auth/spreadsheets';
		const SHEET_NAME = 'Sheet1';  // Default sheet name

		let gapiInited = false;
		let gisInited = false;
		let tokenClient;
		let accessToken = null;
		let activeTimers = {}; // { uuid: { project, task, startTime, accumulatedMs, isPaused } }
		let timerInterval = null;
		let activeChartInstances = []; // To destroy and recreate charts

		let topicInput, startButton, exportButton, activeTimersList, activeCount;
		let noActiveMessage, userIdDisplay, errorMessage, suggestionsDatalist;
		let reportsLoading, reportsError, reportsContent;
		let authorizeButton, signinSection, signinError, mainContent;

		// Initialize DOM references after page load
		window.addEventListener('DOMContentLoaded', () => {
			topicInput = document.getElementById('topic-input');
			startButton = document.getElementById('start-button');
			exportButton = document.getElementById('export-button');
			activeTimersList = document.getElementById('active-timers-list');
			activeCount = document.getElementById('active-count');
			noActiveMessage = document.getElementById('no-active-message');
			userIdDisplay = document.getElementById('user-id-display');
			errorMessage = document.getElementById('error-message');
			suggestionsDatalist = document.getElementById('activity-suggestions');
			reportsLoading = document.getElementById('reports-loading');
			reportsError = document.getElementById('reports-error');
			reportsContent = document.getElementById('reports-content');
			authorizeButton = document.getElementById('authorize-button');
			signinSection = document.getElementById('signin-section');
			signinError = document.getElementById('signin-error');
			mainContent = document.getElementById('main-content');
		});

		// --- Utility Functions ---

		const generateUUID = () => crypto.randomUUID();

		const formatDuration = (seconds) => {
			const h = Math.floor(seconds / 3600);
			const m = Math.floor((seconds % 3600) / 60);
			const s = seconds % 60;
			return [h, m, s].map(v => v < 10 ? "0" + v : v).join(':');
		};

		const getSheetRange = () => `${SHEET_NAME}!A:E`;

		const checkAuth = () => {
			if (!accessToken) {
				throw new Error('Not authenticated. Please sign in.');
			}
		};

		const getRunningTasksKey = (project, task) => `${project.toLowerCase()}:${task.toLowerCase()}`;

		const calculateElapsedMs = (timer) => {
			let elapsed = timer.accumulatedMs || 0;
			if (!timer.isPaused && timer.startTime) {
				elapsed += (Date.now() - timer.startTime.getTime());
			}
			return elapsed;
		};

		// Function to generate distinct colors for charts
		const getDistinctColors = (count) => {
			const colors = [
				'#4f46e5', '#f97316', '#10b981', '#ef4444', '#3b82f6', '#f59e0b', '#8b5cf6', '#ec4899', '#06b6d4', '#84cc16'
			];
			const result = [];
			for (let i = 0; i < count; i++) {
				result.push(colors[i % colors.length]);
			}
			return result;
		};

		// --- Datalist and Suggestions ---
		const HARDCODED_SUGGESTIONS = [
			"Project Gemini / Coding",
			"Project Gemini / Documentation",
			"Internal Admin / Meetings",
			"Internal Admin / Email Response",
			"Client X / Proposal Draft",
			"Learning / Tutorial Videos"
		];

		const populateSuggestions = (recentActivities = []) => {
			suggestionsDatalist.innerHTML = '';
			const combined = new Set([...HARDCODED_SUGGESTIONS, ...recentActivities]);

			combined.forEach(activity => {
				const option = document.createElement('option');
				option.value = activity;
				suggestionsDatalist.appendChild(option);
			});
		};

		const fetchRecentActivities = async () => {
			if (!accessToken) return;
			try {
				const response = await gapi.client.sheets.spreadsheets.values.get({
					spreadsheetId: SPREADSHEET_ID,
					range: getSheetRange(),
				});

				const rows = response.result.values || [];
				const activities = new Set();

				// Skip header row (index 0)
				for (let i = 1; i < rows.length; i++) {
					const row = rows[i];
					if (row[0] && row[1]) {  // project and task columns
						activities.add(`${row[0].trim()} / ${row[1].trim()}`);
					}
				}

				populateSuggestions(Array.from(activities));

			} catch (error) {
				console.error("Error fetching recent activities:", error);
				populateSuggestions([]);
			}
		};

		// --- Core State and UI Management ---

		const saveActiveTimers = () => {
			const serializableTimers = {};
			for (const id in activeTimers) {
				const timer = activeTimers[id];
				serializableTimers[id] = {
					...timer,
					startTime: timer.startTime ? timer.startTime.toISOString() : null
				};
			}
			localStorage.setItem('activeTimers', JSON.stringify(serializableTimers));
			activeCount.textContent = Object.keys(activeTimers).length;
			noActiveMessage.classList.toggle('hidden', Object.keys(activeTimers).length > 0);
		};

		const loadActiveTimers = () => {
			const savedTimers = localStorage.getItem('activeTimers');
			if (savedTimers) {
				const parsedTimers = JSON.parse(savedTimers);
				for (const id in parsedTimers) {
					const timer = parsedTimers[id];
					timer.startTime = timer.startTime ? new Date(timer.startTime) : null;
					activeTimers[id] = timer;
				}
			}
			if (Object.keys(activeTimers).length > 0) {
				startTimerDisplay();
			}
			renderActiveTimers();
		};

		const renderActiveTimers = () => {
			activeTimersList.innerHTML = '';
			const timersArray = Object.entries(activeTimers).map(([id, data]) => ({ id, ...data }));

			if (timersArray.length === 0) {
				noActiveMessage.classList.remove('hidden');
				activeCount.textContent = 0;
				return;
			}
			noActiveMessage.classList.add('hidden');
			activeCount.textContent = timersArray.length;

			const projects = timersArray.reduce((acc, timer) => {
				const projectKey = timer.project;
				if (!acc[projectKey]) { acc[projectKey] = []; }
				acc[projectKey].push(timer);
				return acc;
			}, {});

			const sortedProjects = Object.keys(projects).sort((a, b) => a.toLowerCase().localeCompare(b.toLowerCase()));

			sortedProjects.forEach(projectKey => {
				const tasks = projects[projectKey];
				const projectId = projectKey.replace(/\s/g, '_');

				const projectHeader = document.createElement('div');
				projectHeader.className = 'flex justify-between items-center p-3 bg-gray-200 hover:bg-gray-300 cursor-pointer rounded-lg shadow-sm font-semibold text-gray-800';
				projectHeader.setAttribute('data-target', projectId);
				projectHeader.innerHTML = `
                    <div class="flex items-center space-x-2">
                        <svg id="icon-${projectId}" class="collapse-icon w-4 h-4 text-indigo-600" fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 5l7 7-7 7"></path></svg>
                        <span>${projectKey} (${tasks.length})</span>
                    </div>
                `;

				const taskList = document.createElement('div');
				taskList.id = projectId;
				taskList.className = 'transition-all duration-300 ease-in-out overflow-hidden h-0 space-y-2 pt-2';

				projectHeader.addEventListener('click', () => {
					const isCollapsed = taskList.classList.contains('h-0');
					const icon = document.getElementById(`icon-${projectId}`);

					if (isCollapsed) {
						taskList.classList.remove('h-0');
						taskList.style.height = `${taskList.scrollHeight}px`;
						icon.classList.add('rotate-90');
						projectHeader.classList.add('bg-gray-300');
					} else {
						taskList.style.height = '0';
						setTimeout(() => {
							taskList.classList.add('h-0');
							icon.classList.remove('rotate-90');
							projectHeader.classList.remove('bg-gray-300');
						}, 300);
					}
				});

				tasks.forEach(activity => {
					const card = document.createElement('div');
					card.id = `timer-card-${activity.id}`;

					let cardClasses = 'flex flex-col sm:flex-row justify-between items-start sm:items-center bg-white p-3 rounded-lg shadow-sm border border-gray-100 ml-4';
					if (activity.isPaused) { cardClasses += ' paused-card'; }
					card.className = cardClasses;

					const infoDiv = document.createElement('div');
					infoDiv.className = 'flex flex-col text-left mb-2 sm:mb-0';

					const statusText = activity.isPaused ? '<span class="text-orange-500 font-bold mr-2">(Paused)</span>' : '';

					infoDiv.innerHTML = `
                        <span class="text-sm font-medium text-gray-700">${statusText} ${activity.task}</span>
                        <span class="text-xs text-gray-400">${activity.isPaused ? 'Accumulated' : 'Running Since'} ${activity.startTime ? activity.startTime.toLocaleTimeString() : 'N/A'}</span>
                    `;

					const controlsDiv = document.createElement('div');
					controlsDiv.className = 'flex items-center space-x-2.5 mt-2 sm:mt-0';

					const durationSpan = document.createElement('span');
					durationSpan.id = `duration-${activity.id}`;
					durationSpan.className = 'text-lg font-mono text-gray-800 w-24 text-right flex-shrink-0';
					const initialDuration = Math.floor(calculateElapsedMs(activity) / 1000);
					durationSpan.textContent = formatDuration(initialDuration);

					const toggleBtn = document.createElement('button');
					toggleBtn.textContent = activity.isPaused ? 'Resume' : 'Pause';
					toggleBtn.className = activity.isPaused ?
						'bg-green-500 text-white text-xs px-3 py-1 rounded-lg hover:bg-green-600 transition duration-150 shadow-sm flex-shrink-0' :
						'bg-yellow-500 text-white text-xs px-3 py-1 rounded-lg hover:bg-yellow-600 transition duration-150 shadow-sm flex-shrink-0';
					toggleBtn.addEventListener('click', () => toggleTimer(activity.id));

					const stopBtn = document.createElement('button');
					stopBtn.textContent = 'Stop';
					stopBtn.className = 'bg-red-500 text-white text-xs px-3 py-1 rounded-lg hover:bg-red-600 transition duration-150 shadow-sm flex-shrink-0';
					stopBtn.addEventListener('click', () => stopTimer(activity.id));

					const deleteBtn = document.createElement('button');
					deleteBtn.textContent = 'Delete';
					deleteBtn.className = 'bg-gray-400 text-white text-xs px-3 py-1 rounded-lg hover:bg-gray-500 transition duration-150 shadow-sm flex-shrink-0';
					deleteBtn.addEventListener('click', () => deleteTimer(activity.id));


					controlsDiv.appendChild(durationSpan);
					controlsDiv.appendChild(toggleBtn);
					controlsDiv.appendChild(stopBtn);
					controlsDiv.appendChild(deleteBtn);
					card.appendChild(infoDiv);
					card.appendChild(controlsDiv);

					taskList.appendChild(card);
				});

				activeTimersList.appendChild(projectHeader);
				activeTimersList.appendChild(taskList);
			});
		};

		const updateTimerDisplay = () => {
			let hasActiveTimers = false;
			for (const id in activeTimers) {
				hasActiveTimers = true;
				const activity = activeTimers[id];
				const durationSpan = document.getElementById(`duration-${id}`);

				if (durationSpan) {
					const elapsedMs = calculateElapsedMs(activity);
					const elapsedSeconds = Math.floor(elapsedMs / 1000);
					durationSpan.textContent = formatDuration(elapsedSeconds);
				}
			}

			if (!hasActiveTimers) {
				if (timerInterval) clearInterval(timerInterval);
				timerInterval = null;
			}
		};

		const startTimerDisplay = () => {
			if (!timerInterval) {
				timerInterval = setInterval(updateTimerDisplay, 1000);
			}
		};

		const startNewTimer = () => {
			errorMessage.textContent = '';

			const fullTopic = topicInput.value.trim();
			if (!fullTopic) {
				errorMessage.textContent = "Please enter or select a Project / Task.";
				topicInput.focus();
				return;
			}

			const parts = fullTopic.split('/').map(p => p.trim());
			const project = parts[0] || 'Uncategorized Project';
			const task = parts[1] || 'Uncategorized Task';

			const taskKey = getRunningTasksKey(project, task);

			const duplicateFound = Object.values(activeTimers).some(timer =>
				getRunningTasksKey(timer.project, timer.task) === taskKey
			);

			if (duplicateFound) {
				errorMessage.textContent = `Error: The task "${project} / ${task}" is already running.`;
				return;
			}

			const newId = generateUUID();
			activeTimers[newId] = {
				project: project,
				task: task,
				startTime: new Date(),
				accumulatedMs: 0,
				isPaused: false
			};

			topicInput.value = '';
			saveActiveTimers();
			renderActiveTimers();
			startTimerDisplay();
		};

		const toggleTimer = (id) => {
			const timer = activeTimers[id];
			if (!timer) return;

			if (timer.isPaused) {
				timer.isPaused = false;
				timer.startTime = new Date();
			} else {
				const elapsedMsSinceStart = Date.now() - timer.startTime.getTime();
				timer.accumulatedMs += elapsedMsSinceStart;
				timer.startTime = null;
				timer.isPaused = true;
			}

			saveActiveTimers();
			renderActiveTimers();
			startTimerDisplay();
		};

		const deleteTimer = (id) => {
			if (!activeTimers[id]) return;

			delete activeTimers[id];
			saveActiveTimers();
			renderActiveTimers();
		};


		const stopTimer = async (id) => {
			const activity = activeTimers[id];
			if (!activity) return;

			const finalDurationMs = calculateElapsedMs(activity);
			const durationSeconds = Math.round(finalDurationMs / 1000);

			if (durationSeconds <= 0) {
				delete activeTimers[id];
				saveActiveTimers();
				renderActiveTimers();
				errorMessage.textContent = 'Task stopped instantly and deleted (zero duration).';
				setTimeout(() => errorMessage.textContent = '', 3000);
				return;
			}

			const endTime = new Date();

			delete activeTimers[id];
			saveActiveTimers();
			renderActiveTimers();

			const tempStatus = document.createElement('p');
			tempStatus.className = 'text-center text-sm text-blue-600 mt-2';
			activeTimersList.insertAdjacentElement('afterend', tempStatus);
			tempStatus.textContent = `Saving ${activity.project} / ${activity.task} ...`;

			try {
				checkAuth();

				// Prepare row data matching sheet columns: project, task, totalDurationMs, durationSeconds, endTime
				const rowData = [
					[
						activity.project,
						activity.task,
						finalDurationMs,
						durationSeconds,
						endTime.toISOString()
					]
				];

				await gapi.client.sheets.spreadsheets.values.append({
					spreadsheetId: SPREADSHEET_ID,
					range: getSheetRange(),
					valueInputOption: 'RAW',
					resource: { values: rowData }
				});

				tempStatus.textContent = `Saved ${activity.project} / ${activity.task} (${formatDuration(durationSeconds)})`;
				tempStatus.className = 'text-center text-sm text-green-600 mt-2';
				setTimeout(() => tempStatus.remove(), 4000);

				fetchRecentActivities();

			} catch (e) {
				console.error("Error saving to sheet:", e);
				tempStatus.textContent = `ERROR saving ${activity.project} / ${activity.task}. Check console.`;
				tempStatus.className = 'text-center text-sm text-red-600 mt-2';
			}
		};

		const openSheet = () => {
			const sheetUrl = `https://docs.google.com/spreadsheets/d/${SPREADSHEET_ID}`;
			window.open(sheetUrl, '_blank');
		};

		// --- Tab Switching Logic ---
		const switchTab = (targetTab) => {
			document.querySelectorAll('.content-view').forEach(view => view.classList.add('hidden'));
			document.querySelectorAll('.tab-button').forEach(btn => btn.classList.remove('active'));

			document.getElementById(`view-${targetTab}`).classList.remove('hidden');
			document.getElementById(`tab-${targetTab}`).classList.add('active');

			if (targetTab === 'reports') {
				renderReportsView();
			}
		};


		// --- REPORT GENERATION (P2 Implementation) ---

		const renderReportsView = async () => {
			if (!accessToken) { return; }

			reportsLoading.classList.remove('hidden');
			reportsContent.classList.add('hidden');
			reportsError.classList.add('hidden');

			// Destroy existing charts to prevent memory leaks and canvas conflicts
			activeChartInstances.forEach(chart => chart.destroy());
			activeChartInstances = [];

			try {
				const response = await gapi.client.sheets.spreadsheets.values.get({
					spreadsheetId: SPREADSHEET_ID,
					range: getSheetRange(),
				});

				const rows = response.result.values || [];
				const allEntries = [];

				// Parse rows into entry objects, skip header row
				for (let i = 1; i < rows.length; i++) {
					const row = rows[i];
					if (row.length >= 5) {
						allEntries.push({
							project: row[0],
							task: row[1],
							totalDurationMs: parseFloat(row[2]) || 0,
							durationSeconds: parseInt(row[3]) || 0,
							endTime: { toDate: () => new Date(row[4]) }  // Mock Firestore Timestamp structure
						});
					}
				}

				if (allEntries.length === 0) {
					reportsLoading.textContent = "No data recorded yet. Start tracking to see reports!";
					return;
				}

				// 1. Prepare Data for Project Pie Chart
				const projectDurations = allEntries.reduce((acc, entry) => {
					const project = entry.project || 'Unknown';
					acc[project] = (acc[project] || 0) + entry.totalDurationMs;
					return acc;
				}, {});

				const projectLabels = Object.keys(projectDurations);
				const projectData = projectLabels.map(label => projectDurations[label]);
				const projectColors = getDistinctColors(projectLabels.length);

				// 2. Prepare Data for Daily Bar Chart
				const dailyDurations = {};
				const now = new Date();
				now.setHours(0, 0, 0, 0);
				const oneDayMs = 24 * 60 * 60 * 1000;

				// Initialize last 7 days (including today)
				const lastSevenDaysLabels = [];
				for (let i = 6; i >= 0; i--) {
					const day = new Date(now.getTime() - i * oneDayMs);
					const dateKey = day.toISOString().split('T')[0];
					lastSevenDaysLabels.push(day.toLocaleDateString('en-US', { weekday: 'short', day: 'numeric' }));
					dailyDurations[dateKey] = 0;
				}

				// Aggregate data for the last 7 days
				allEntries.forEach(entry => {
					if (entry.endTime) {
						const dateKey = entry.endTime.toDate().toISOString().split('T')[0];
						if (dailyDurations.hasOwnProperty(dateKey)) {
							dailyDurations[dateKey] += entry.totalDurationMs;
						}
					}
				});

				const dailyDataMs = Object.values(dailyDurations).slice(-7); // Ensure we only take 7 days, in order
				const dailyDataHours = dailyDataMs.map(ms => ms / 3600000); // Convert milliseconds to hours

				reportsLoading.classList.add('hidden');
				reportsContent.classList.remove('hidden');

				// --- Generate Project Pie Chart ---
				const pieCtx = document.getElementById('project-pie-chart').getContext('2d');
				const pieChart = new Chart(pieCtx, {
					type: 'doughnut',
					data: {
						labels: projectLabels,
						datasets: [{
							data: projectData,
							backgroundColor: projectColors,
							hoverOffset: 4
						}]
					},
					options: {
						responsive: true,
						maintainAspectRatio: false,
						plugins: {
							legend: { position: 'right' },
							tooltip: {
								callbacks: {
									label: (context) => {
										const totalSeconds = Math.round(context.parsed / 1000);
										return `${context.label}: ${formatDuration(totalSeconds)}`;
									}
								}
							}
						}
					}
				});
				activeChartInstances.push(pieChart);


				// --- Generate Daily Bar Chart ---
				const barCtx = document.getElementById('daily-bar-chart').getContext('2d');
				const barChart = new Chart(barCtx, {
					type: 'bar',
					data: {
						labels: lastSevenDaysLabels,
						datasets: [{
							label: 'Hours Logged',
							data: dailyDataHours,
							backgroundColor: '#4f46e5',
							borderRadius: 4
						}]
					},
					options: {
						responsive: true,
						maintainAspectRatio: false,
						scales: {
							y: {
								beginAtZero: true,
								title: { display: true, text: 'Hours' }
							}
						},
						plugins: {
							legend: { display: false },
							tooltip: {
								callbacks: {
									label: (context) => {
										const hours = context.parsed.y.toFixed(2);
										return `Total: ${hours} hours`;
									}
								}
							}
						}
					}
				});
				activeChartInstances.push(barChart);


			} catch (e) {
				console.error("Error generating reports:", e);
				reportsLoading.classList.add('hidden');
				reportsError.classList.remove('hidden');
			}
		};

		// --- Google API Initialization and Authentication ---

		function gapiLoaded() {
			gapi.load('client', initializeGapiClient);
		}

		async function initializeGapiClient() {
			try {
				await gapi.client.init({
					apiKey: API_KEY,
					discoveryDocs: [DISCOVERY_DOC],
				});
				gapiInited = true;
				maybeEnableButtons();
			} catch (error) {
				console.error('Error initializing GAPI client:', error);
				if (userIdDisplay) userIdDisplay.textContent = 'Error: Failed to initialize API';
			}
		}

		function gisLoaded() {
			tokenClient = google.accounts.oauth2.initTokenClient({
				client_id: CLIENT_ID,
				scope: SCOPES,
				callback: handleAuthCallback,
			});
			gisInited = true;
			maybeEnableButtons();
		}

		function maybeEnableButtons() {
			if (gapiInited && gisInited && signinSection) {
				signinSection.classList.remove('hidden');
				userIdDisplay.textContent = 'Status: Ready to sign in';
				authorizeButton.addEventListener('click', handleAuthClick);
			}
		}

		function handleAuthClick() {
			if (!tokenClient) return;
			tokenClient.requestAccessToken();
		}

		function handleAuthCallback(response) {
			if (response.error) {
				console.error('Auth error:', response);
				signinError.textContent = `Authentication failed: ${response.error}`;
				return;
			}

			accessToken = response.access_token;
			gapi.client.setToken({ access_token: accessToken });

			// Hide signin, show main content
			signinSection.classList.add('hidden');
			mainContent.classList.remove('hidden');
			userIdDisplay.textContent = 'Status: Signed in';

			// Initialize app functionality
			startButton.addEventListener('click', startNewTimer);
			exportButton.addEventListener('click', openSheet);

			// Set up tab switching
			document.getElementById('tab-tracker').addEventListener('click', () => switchTab('tracker'));
			document.getElementById('tab-reports').addEventListener('click', () => switchTab('reports'));

			loadActiveTimers();
			fetchRecentActivities();
		}

		// Make functions globally available for script loading
		window.gapiLoaded = gapiLoaded;
		window.gisLoaded = gisLoaded;
	</script>
</body>

</html>
